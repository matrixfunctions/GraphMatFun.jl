SHELL := /bin/bash
.SILENT: all gen run_c run_julia run_matlab run clean

N=1000 # Default matrix size

# Clean the /tmp/ directory, then generate the code, and run the experiments.
all: clean gen run

# Generate and compile test files in /tmp/.
# Nothing happens in the current directory.
gen:
	echo "Generating C, Julia, and Matlab code..."
	cd ../..; julia simulations/cputime/gen_cputime_all_lang.jl &> \
		/tmp/gen_all_lang.jl.output;
	cp c_main_template.c /tmp/;
	echo "Compiling generated C code..."
	for file in `ls -d /tmp/* | grep '.c$$' | grep -P 'MKL|OpenBLAS'`; do \
		filebasename=`basename $$file`; \
		filename=$${filebasename%.*}; \
		extension=$${filebasename#*.}; \
		type="$${filename#"$${filename%_*}_"}"; \
		cat /tmp/c_main_template.c | \
			sed -e "s/FUNNAME/d$$filename/" -e "s/MATORDER/$(N)/"\
			>> $$file; \
		if [ $$extension == "c" ]; then \
			if [ $$type == "MKL" ]; then \
				gcc -Wall -lm -o /tmp/$$filename $$file -lmkl_rt; \
			else \
				gcc -Wall -lm  -o /tmp/$$filename $$file -lblas -llapacke; \
			fi; \
		fi; \
	done

# Run experiments generated by target gen in /tmp/.
run: run_c run_julia run_matlab

run_c:
	if [ `cat /sys/devices/system/cpu/intel_pstate/no_turbo`!="1" ]; then \
		echo "Warning: CPU-time boosting seems to be enabled."; \
		echo "Disable on ubuntu: https://askubuntu.com/a/620114"; \
	fi
	for file in `ls -d /tmp/* | grep -P 'MKL|OpenBLAS'`; do \
		if [ -x "$$file" ]; then \
			$$file; \
		fi; \
	done

run_julia:
	cd /tmp/; julia run_cputime_julia_MKL.jl &> \
		/tmp/run_cputime_julia_MKL.jl.output
	cd /tmp/; julia run_cputime_julia_OpenBLAS.jl &> \
		/tmp/run_cputime_julia_OpenBLAS.jl.output

run_matlab:
	cd /tmp/; matlab -batch "run_cputime_matlab_OpenBLAS" &> \
		/tmp/run_cputime_matlab_OpenBLAS.output

# Clean files in the /tmp/ directory.
clean:
	echo "Removing C source and executable files..."
	for file in `ls -d /tmp/* | grep -P 'MKL|OpenBLAS'`; do \
		executable=$${file%.*}; \
		rm -f $$file $$executable; \
	done
	echo "Removing Julia files..."
	rm -f /tmp/*.jl
	echo "Removing Matlab files..."
	rm -f /tmp/*.m
